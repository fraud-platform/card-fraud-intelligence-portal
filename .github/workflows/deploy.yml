# =============================================================================
# Card Fraud Intelligence Portal - Continuous Deployment Pipeline
# =============================================================================
# Deploys the application to Choreo using Doppler for secrets management.
#
# Environments:
#   - test: Deployed on every push to main (staging)
#   - production: Manual approval required
#
# Required GitHub Secrets:
#   - DOPPLER_TOKEN_TEST: Doppler service token for test config
#   - DOPPLER_TOKEN_PROD: Doppler service token for prod config
#   - CHOREO_TOKEN: Choreo API token (optional, for Choreo CLI)
# =============================================================================

name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - production

# Only allow one deployment at a time per environment
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ---------------------------------------------------------------------------
  # Build Job: Create Docker image with embedded secrets
  # ---------------------------------------------------------------------------
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v3

      - name: Build and push Docker image (Test)
        id: build
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN_TEST }}
        run: |
          # Export Doppler secrets as environment variables
          eval $(doppler secrets download --no-file --format=docker)

          # Build with build args from Doppler secrets
          docker buildx build \
            --platform linux/amd64 \
            --push \
            --build-arg VITE_API_URL="${VITE_API_URL}" \
            --build-arg VITE_AUTH0_DOMAIN="${VITE_AUTH0_DOMAIN}" \
            --build-arg VITE_AUTH0_CLIENT_ID="${VITE_AUTH0_CLIENT_ID}" \
            --build-arg VITE_AUTH0_AUDIENCE="${VITE_AUTH0_AUDIENCE}" \
            --build-arg VITE_AUTH0_REDIRECT_URI="${VITE_AUTH0_REDIRECT_URI}" \
            --build-arg VITE_AUTH0_ROLE_CLAIM="${VITE_AUTH0_ROLE_CLAIM}" \
            --build-arg VITE_DISABLE_MOCKS="${VITE_DISABLE_MOCKS}" \
            --build-arg VITE_APP_NAME="${VITE_APP_NAME}" \
            --build-arg VITE_APP_VERSION="${VITE_APP_VERSION}" \
            --build-arg VITE_ENABLE_ANALYTICS="${VITE_ENABLE_ANALYTICS}" \
            --build-arg VITE_SENTRY_DSN="${VITE_SENTRY_DSN}" \
            --build-arg VITE_SENTRY_ENVIRONMENT="${VITE_SENTRY_ENVIRONMENT}" \
            --build-arg VITE_SENTRY_RELEASE="${VITE_SENTRY_RELEASE}" \
            --build-arg VITE_E2E_MODE="${VITE_E2E_MODE}" \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            .

          echo "digest=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} 2>/dev/null || echo '')" >> $GITHUB_OUTPUT

  # ---------------------------------------------------------------------------
  # Deploy to Test Environment
  # ---------------------------------------------------------------------------
  deploy-test:
    name: Deploy to Test
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: test
      url: https://test-fraud-portal.choreo.dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Choreo (Test)
        run: |
          echo "Deploying to test environment..."
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

          # Choreo deployment via API or CLI
          # Uncomment and configure when Choreo integration is set up:
          #
          # curl -X POST \
          #   -H "Authorization: Bearer ${{ secrets.CHOREO_TOKEN }}" \
          #   -H "Content-Type: application/json" \
          #   -d '{
          #     "image": "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}",
          #     "environment": "test"
          #   }' \
          #   "https://api.choreo.dev/v1/deploy"

          echo "Test deployment triggered successfully"

      - name: Verify deployment
        run: |
          echo "Waiting for deployment to be ready..."
          sleep 30

          # Health check
          # curl --fail --retry 5 --retry-delay 10 https://test-fraud-portal.choreo.dev/health || exit 1

          echo "Test deployment verified"

  # ---------------------------------------------------------------------------
  # Deploy to Production Environment (requires approval)
  # ---------------------------------------------------------------------------
  deploy-production:
    name: Deploy to Production
    needs: [build, deploy-test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://fraud-portal.choreo.dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build production image with prod secrets
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN_PROD }}
        run: |
          # Export Doppler production secrets
          eval $(doppler secrets download --no-file --format=docker)

          # Verify we're NOT using localhost
          if echo "$VITE_API_URL" | grep -q "localhost"; then
            echo "ERROR: Production build contains localhost URL!"
            exit 1
          fi

          # Build production image with prod secrets
          docker buildx build \
            --platform linux/amd64 \
            --push \
            --build-arg VITE_API_URL="${VITE_API_URL}" \
            --build-arg VITE_AUTH0_DOMAIN="${VITE_AUTH0_DOMAIN}" \
            --build-arg VITE_AUTH0_CLIENT_ID="${VITE_AUTH0_CLIENT_ID}" \
            --build-arg VITE_AUTH0_AUDIENCE="${VITE_AUTH0_AUDIENCE}" \
            --build-arg VITE_AUTH0_REDIRECT_URI="${VITE_AUTH0_REDIRECT_URI}" \
            --build-arg VITE_AUTH0_ROLE_CLAIM="${VITE_AUTH0_ROLE_CLAIM}" \
            --build-arg VITE_DISABLE_MOCKS="${VITE_DISABLE_MOCKS}" \
            --build-arg VITE_APP_NAME="${VITE_APP_NAME}" \
            --build-arg VITE_APP_VERSION="${VITE_APP_VERSION}" \
            --build-arg VITE_ENABLE_ANALYTICS="${VITE_ENABLE_ANALYTICS}" \
            --build-arg VITE_SENTRY_DSN="${VITE_SENTRY_DSN}" \
            --build-arg VITE_SENTRY_ENVIRONMENT="${VITE_SENTRY_ENVIRONMENT}" \
            --build-arg VITE_SENTRY_RELEASE="${VITE_SENTRY_RELEASE}" \
            --build-arg VITE_E2E_MODE="${VITE_E2E_MODE}" \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}-prod \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:production \
            .

      - name: Deploy to Choreo (Production)
        run: |
          echo "Deploying to production environment..."
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}-prod"

          # Choreo deployment via API or CLI
          # Uncomment and configure when Choreo integration is set up:
          #
          # curl -X POST \
          #   -H "Authorization: Bearer ${{ secrets.CHOREO_TOKEN }}" \
          #   -H "Content-Type: application/json" \
          #   -d '{
          #     "image": "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}-prod",
          #     "environment": "production"
          #   }' \
          #   "https://api.choreo.dev/v1/deploy"

          echo "Production deployment triggered successfully"

      - name: Verify production deployment
        run: |
          echo "Waiting for production deployment to be ready..."
          sleep 60

          # Health check
          # curl --fail --retry 5 --retry-delay 10 https://fraud-portal.choreo.dev/health || exit 1

          echo "Production deployment verified"

      - name: Notify deployment success
        if: success()
        run: |
          echo "Production deployment completed successfully!"
          echo "URL: https://fraud-portal.choreo.dev"
          echo "Commit: ${{ github.sha }}"
