# =============================================================================
# Card Fraud Intelligence Portal - Nginx Configuration
# =============================================================================
# Serves the Vite SPA with proper routing, security headers, and compression
# =============================================================================

server {
    listen 5173;
    server_name _;
    root /usr/share/nginx/html;
    index index.html;

    # Hide Nginx version
    server_tokens off;

    # ---------------------------------------------------------------------------
    # Security Headers
    # ---------------------------------------------------------------------------
    # Prevent clickjacking
    add_header X-Frame-Options "DENY" always;

    # Prevent MIME type sniffing
    add_header X-Content-Type-Options "nosniff" always;

    # XSS protection (legacy, but still useful for older browsers)
    add_header X-XSS-Protection "1; mode=block" always;

    # Referrer policy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # HSTS (HTTP Strict Transport Security) with preload
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # Permissions policy (restrict browser features)
    add_header Permissions-Policy "camera=(), geolocation=(), microphone=(), payment=()" always;

    # Content Security Policy
    # Allows: self, Auth0 domain, API domain, inline styles (Ant Design)
    # Note: Update 'connect-src' with your actual API and Auth0 domains
    #
    # For nonce-based CSP, generate a per-request nonce on the server and inject it into both:
    #  - the `Content-Security-Policy` header (e.g. "script-src 'self' 'nonce-$request_nonce' ...")
    #  - a `<meta name="csp-nonce" content="<nonce>">` tag in the served HTML
    # Example (pseudocode / placeholder):
    # add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'nonce-$request_nonce' ; style-src 'self' 'nonce-$request_nonce' ; ..." always;
    # Implement the nonce generation via templating, an edge function, or server middleware; start in Report-Only mode and verify matching nonces before enforcing.
    # Current guidance: remove 'unsafe-eval' and inline script allowances. Style inline remains allowed temporarily until inline styles are migrated.
    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://*.auth0.com https://*.sentry.io; frame-ancestors 'none'; base-uri 'self'; form-action 'self';" always;

    # ---------------------------------------------------------------------------
    # Compression
    # ---------------------------------------------------------------------------
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/x-javascript
        application/json
        application/xml
        application/xml+rss
        application/xhtml+xml
        font/woff
        font/woff2
        image/svg+xml;

    # ---------------------------------------------------------------------------
    # Caching
    # ---------------------------------------------------------------------------
    # Cache static assets aggressively (they have content hashes)
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";

        # Re-add security headers (location blocks override server-level headers)
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
    }

    # Don't cache HTML (always get fresh version)
    location ~* \.html$ {
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate";

        # Security headers
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Permissions-Policy "camera=(), geolocation=(), microphone=(), payment=()" always;
    }

    # ---------------------------------------------------------------------------
    # SPA Routing
    # ---------------------------------------------------------------------------
    # All routes go to index.html (client-side routing)
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ---------------------------------------------------------------------------
    # Health Check Endpoint
    # ---------------------------------------------------------------------------
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # ---------------------------------------------------------------------------
    # Security: Block sensitive files
    # ---------------------------------------------------------------------------
    # Block access to hidden files
    location ~ /\. {
        deny all;
        return 404;
    }

    # Block access to backup files
    location ~* \.(bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist)$ {
        deny all;
        return 404;
    }

    # ---------------------------------------------------------------------------
    # Error Pages
    # ---------------------------------------------------------------------------
    error_page 404 /index.html;
    error_page 500 502 503 504 /index.html;
}
